
<video id="video" width="640" height="480" autoplay></video>
<button id="snap">Snap Photo</button>
<canvas id="canvas" width="640" height="480"></canvas>

<!-- <p>Image:</p>
  <input id="image" type="file" />
  <button id="upload">upload</button>

  <br>
  <br>

  <p>Audio:</p>
  <input id="audio" type="file" />
  <button id="upload2">upload audio</button> -->


<script>
var video = document.getElementById('video');

if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    // Not adding `{ audio: true }` since we only want video now
    navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
        video.src = window.URL.createObjectURL(stream);
        // video.play();
    });
}


// Elements for taking the snapshot
var canvas = document.getElementById('canvas');
var context = canvas.getContext('2d');
var video = document.getElementById('video');

var canvas = document.getElementById('canvas');
var dataURL = canvas.toDataURL();


// Trigger photo take
document.getElementById("snap").addEventListener("click", function() {
  context.drawImage(video, 0, 0, 640, 480);
  var dataURL = canvas.toDataURL();
  baseFile = dataURL.slice(22)

  // console.log(baseFile);

  // Image Recognition API

      var b=JSON.stringify({"requests":[{  "image":{
        "content":baseFile
      }  ,  "features": [{"type":"FACE_DETECTION","maxResults":5}]    } ]});
      
      var e = new XMLHttpRequest;

      e.open("POST","https://vision.googleapis.com/v1/images:annotate?key=AIzaSyAirYvq_dB6tcH1tM6TEQKTyNcEMid8bAs",!0);
      e.send(b)

        e.onload=function(){
        const path = JSON.parse(e.responseText);
        const newPath = path.responses[0].faceAnnotations[0].landmarks;
        const fdPath = path.responses[0].faceAnnotations[0].fdBoundingPoly;

        const fdPath1 = (fdPath.vertices[0]); 
        const fdPath2 = (fdPath.vertices[1]); 
        const fdPath3 = (fdPath.vertices[2]); 
        const fdPath4 = (fdPath.vertices[3]); 

        const LEFT_EYE_TOP_BOUNDARY = newPath[16].position;
        const LEFT_EYE_BOTTOM_BOUNDARY = newPath[18].position;
        const LEFT_EYE_PUPIL = newPath[20].position;
        const RIGHT_EYE_TOP_BOUNDARY = newPath[21].position;
        const RIGHT_EYE_BOTTOM_BOUNDARY = newPath[23].position;
        const RIGHT_EYE_PUPIL = newPath[25].position;
        const LEFT_EYEBROW_UPPER_MIDPOINT = newPath[26].position;
        const RIGHT_EYEBROW_UPPER_MIDPOINT = newPath[27].position;

        let pointsForClosed = 0
        let pointsForOpen = 0

        // console.log("LEFT_EYE_TOP_BOUNDARY", LEFT_EYE_TOP_BOUNDARY.y)
        // console.log("LEFT_EYE_BOTTOM_BOUNDARY", LEFT_EYE_BOTTOM_BOUNDARY.y)
        // console.log("LEFT_EYE_PUPIL", LEFT_EYE_PUPIL.y)
        // console.log("RIGHT_EYE_TOP_BOUNDARY", RIGHT_EYE_TOP_BOUNDARY.y)
        // console.log("RIGHT_EYE_BOTTOM_BOUNDARY", RIGHT_EYE_BOTTOM_BOUNDARY.y)
        // console.log("RIGHT_EYE_PUPIL", RIGHT_EYE_PUPIL.y)
        // console.log("LEFT_EYEBROW_UPPER_MIDPOINT", LEFT_EYEBROW_UPPER_MIDPOINT.y)
        // console.log("RIGHT_EYEBROW_UPPER_MIDPOINT", RIGHT_EYEBROW_UPPER_MIDPOINT.y)


        if( (Math.abs(Math.abs(parseInt(fdPath1.x)) - Math.abs(parseInt(fdPath2.x))) < 200) & ( Math.abs(Math.abs(parseInt(fdPath1.y)) - Math.abs(parseInt(fdPath3.y))) < 200 )){
          
          console.log(Math.abs(Math.abs(parseInt(fdPath1.x)) - Math.abs(parseInt(fdPath2.x))))
          console.log(Math.abs(Math.abs(parseInt(fdPath1.y)) - Math.abs(parseInt(fdPath3.y))))

        if (
          ((Math.abs(parseFloat(RIGHT_EYE_BOTTOM_BOUNDARY.y) - parseFloat(RIGHT_EYE_PUPIL.y)) <= 6) & (Math.abs(parseFloat(RIGHT_EYE_PUPIL.y) - parseFloat(RIGHT_EYE_TOP_BOUNDARY.y)) <= 6))
          ||
          ((Math.abs(parseFloat(LEFT_EYE_BOTTOM_BOUNDARY.y) - parseFloat(LEFT_EYE_PUPIL.y)) <= 6) & (Math.abs(parseFloat(LEFT_EYE_PUPIL.y) - parseFloat(LEFT_EYE_TOP_BOUNDARY.y)) <= 6)))
              {
                console.log(' 1left',Math.abs(parseFloat(RIGHT_EYE_BOTTOM_BOUNDARY.y) - parseFloat(RIGHT_EYE_PUPIL.y)), Math.abs(parseFloat(RIGHT_EYE_PUPIL.y) - parseFloat(RIGHT_EYE_TOP_BOUNDARY.y)))
                console.log('1right',Math.abs(parseFloat(LEFT_EYE_BOTTOM_BOUNDARY.y) - parseFloat(LEFT_EYE_PUPIL.y)), Math.abs(parseFloat(LEFT_EYE_PUPIL.y) - parseFloat(LEFT_EYE_TOP_BOUNDARY.y)))
                pointsForClosed += 1
              }


              else{
                console.log('2left',Math.abs(parseFloat(RIGHT_EYE_BOTTOM_BOUNDARY.y) - parseFloat(RIGHT_EYE_PUPIL.y)), Math.abs(parseFloat(RIGHT_EYE_PUPIL.y) - parseFloat(RIGHT_EYE_TOP_BOUNDARY.y)))
                console.log('2right',Math.abs(parseFloat(LEFT_EYE_BOTTOM_BOUNDARY.y) - parseFloat(LEFT_EYE_PUPIL.y)), Math.abs(parseFloat(LEFT_EYE_PUPIL.y) - parseFloat(LEFT_EYE_TOP_BOUNDARY.y)))
                pointsForOpen += 1
              }

            if(pointsForOpen >= pointsForClosed){
              console.log('Eyes are open')
            }else{
              console.log('Eyes are closed')
            }

          }else{
            console.log('You are too close to the screen')
          }

      };

    })




</script>
